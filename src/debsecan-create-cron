#!/bin/bash

set -e

FILE=/etc/cron.d/debsecan

usage () {
    echo "usage: $0 SUITE"
    exit 1
}

if test "x$1" = "x--suite" ; then
    shift
fi

if test $# -ne 1 ; then
    usage
fi

if test -z "$1" ; then
    usage
fi

if test -e "$FILE" ; then
    if grep '^# AUTOMATICALLY GENERATED$' "$FILE" > /dev/null ; then
	:
    else
	echo "error: cron file $FILE already exists"
	exit 1
    fi
fi

MIN=$(($RANDOM % 60))

cat > "$FILE" <<EOF
# cron entry for debsecan
#
# AUTOMATICALLY GENERATED
# (Delete the preceding line if you edit this file.)

$MIN * * * * daemon /usr/bin/debsecan --suite $1 --mailto root --cron
# (Note: debsecan delays actual processing past 2:00 AM, and runs only
# once per day.)
EOF

echo "$0: cron file $FILE updated."
exit 0
